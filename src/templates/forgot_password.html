{% extends "base.html" %}

{% block title %}Recuperar Contraseña - MiloApps{% endblock %}

{% block extra_css %}
<style>
    .recovery-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .recovery-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        max-width: 500px;
        width: 100%;
        padding: 3rem;
    }
    
    .brand-logo {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .form-floating {
        margin-bottom: 1.5rem;
    }
    
    .form-floating > .form-control {
        height: calc(3.5rem + 2px);
        padding: 1rem 0.75rem;
    }
    
    .btn-recovery {
        height: 3.5rem;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 0.5rem;
        font-weight: 600;
        color: #6c757d;
    }
    
    .step.active {
        background-color: var(--primary-color);
        color: white;
    }
    
    .step.completed {
        background-color: var(--success-color);
        color: white;
    }
    
    .step-connector {
        height: 2px;
        width: 50px;
        background-color: #e9ecef;
        align-self: center;
    }
    
    .step-connector.completed {
        background-color: var(--success-color);
    }
    
    .info-box {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    .success-animation {
        color: var(--success-color);
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: checkmark 0.5s ease-in-out;
    }
    
    @keyframes checkmark {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="recovery-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="recovery-card mx-auto">
                    <div class="text-center mb-4">
                        <h2 class="brand-logo text-primary">
                            <i class="fas fa-cat"></i> MiloApps
                        </h2>
                    </div>
                    
                    {% if not token %}
                        <!-- Step 1: Request Reset -->
                        <div class="step-indicator">
                            <div class="step active">1</div>
                            <div class="step-connector"></div>
                            <div class="step">2</div>
                            <div class="step-connector"></div>
                            <div class="step">3</div>
                        </div>
                        
                        <div class="text-center mb-4">
                            <h4 class="mb-2">Recuperar Contraseña</h4>
                            <p class="text-muted">
                                Ingresa tu email y te enviaremos un enlace para restablecer tu contraseña
                            </p>
                        </div>
                        
                        <form method="POST">
                            {{ form.hidden_tag() }}
                            
                            <div class="form-floating">
                                {{ form.email(class="form-control", placeholder="Correo electrónico") }}
                                {{ form.email.label(class="form-label") }}
                                {% if form.email.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.email.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid mb-3">
                                {{ form.submit(class="btn btn-primary btn-recovery") }}
                            </div>
                            
                            <div class="text-center">
                                <a href="{{ url_for('auth.login') }}" class="text-decoration-none">
                                    <i class="fas fa-arrow-left"></i> Volver al inicio de sesión
                                </a>
                            </div>
                        </form>
                        
                        <div class="info-box mt-4">
                            <h6><i class="fas fa-info-circle text-primary"></i> Información</h6>
                            <small class="text-muted">
                                Si no recibes el email en unos minutos, revisa tu carpeta de spam
                                o verifica que el email sea correcto.
                            </small>
                        </div>
                        
                    {% elif show_reset_form %}
                        <!-- Step 3: Reset Password -->
                        <div class="step-indicator">
                            <div class="step completed">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="step-connector completed"></div>
                            <div class="step completed">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="step-connector completed"></div>
                            <div class="step active">3</div>
                        </div>
                        
                        <div class="text-center mb-4">
                            <h4 class="mb-2">Nueva Contraseña</h4>
                            <p class="text-muted">
                                Ingresa tu nueva contraseña segura
                            </p>
                        </div>
                        
                        <form method="POST">
                            {{ form.hidden_tag() }}
                            
                            <div class="form-floating">
                                {{ form.password(class="form-control", placeholder="Nueva contraseña", id="password") }}
                                {{ form.password.label(class="form-label") }}
                                {% if form.password.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.password.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Password Strength Indicator -->
                            <div class="password-strength mb-3">
                                <div class="strength-bar">
                                    <div class="strength-fill"></div>
                                </div>
                                <small class="strength-text text-muted">Ingresa una contraseña</small>
                            </div>
                            
                            <div class="form-floating">
                                {{ form.password2(class="form-control", placeholder="Confirmar nueva contraseña") }}
                                {{ form.password2.label(class="form-label") }}
                                {% if form.password2.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.password2.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid mb-3">
                                {{ form.submit(class="btn btn-primary btn-recovery") }}
                            </div>
                        </form>
                        
                        <div class="info-box">
                            <h6><i class="fas fa-shield-alt text-success"></i> Seguridad</h6>
                            <small class="text-muted">
                                Tu nueva contraseña debe tener al menos 8 caracteres y contener
                                mayúsculas, minúsculas, números y símbolos.
                            </small>
                        </div>
                        
                    {% else %}
                        <!-- Step 2: Email Sent Confirmation -->
                        <div class="step-indicator">
                            <div class="step completed">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="step-connector completed"></div>
                            <div class="step active">2</div>
                            <div class="step-connector"></div>
                            <div class="step">3</div>
                        </div>
                        
                        <div class="text-center">
                            <div class="success-animation">
                                <i class="fas fa-envelope-circle-check"></i>
                            </div>
                            
                            <h4 class="mb-3">Email Enviado</h4>
                            <p class="text-muted mb-4">
                                Hemos enviado un enlace de recuperación a tu correo electrónico.
                                Haz clic en el enlace para restablecer tu contraseña.
                            </p>
                            
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                                    <i class="fas fa-redo"></i> Reenviar Email
                                </button>
                                <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Volver al Login
                                </a>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <h6><i class="fas fa-clock text-warning"></i> Importante</h6>
                            <small class="text-muted">
                                El enlace de recuperación expirará en 1 hora por seguridad.
                                Si no lo encuentras, revisa tu carpeta de spam.
                            </small>
                        </div>
                    {% endif %}
                    
                    <!-- Help Section -->
                    <div class="text-center mt-4 pt-3 border-top">
                        <small class="text-muted">
                            ¿Necesitas ayuda? <a href="#" class="text-primary">Contacta soporte</a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('password');
    
    if (passwordField) {
        // Password strength indicator (same as register)
        const strengthBar = document.querySelector('.strength-bar');
        const strengthText = document.querySelector('.strength-text');
        
        passwordField.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
        
        function checkPasswordStrength(password) {
            let strength = 0;
            let feedback = '';
            
            // Reset classes
            strengthBar.className = 'strength-bar';
            
            if (password.length === 0) {
                strengthText.textContent = 'Ingresa una contraseña';
                strengthText.className = 'strength-text text-muted';
                return;
            }
            
            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            
            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            // Determine strength level  
            if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
                feedback = 'Débil - Necesita más caracteres y variedad';
                strengthText.className = 'strength-text text-danger';
            } else if (strength <= 3) {
                strengthBar.classList.add('strength-fair');
                feedback = 'Regular - Agrega más variedad de caracteres';
                strengthText.className = 'strength-text text-warning';
            } else if (strength <= 4) {
                strengthBar.classList.add('strength-good');
                feedback = 'Buena - Casi perfecta';
                strengthText.className = 'strength-text text-info';
            } else {
                strengthBar.classList.add('strength-strong');
                feedback = 'Excelente - Contraseña muy segura';
                strengthText.className = 'strength-text text-success';
            }
            
            strengthText.textContent = feedback;
        }
        
        // Password confirmation validation
        const confirmPasswordField = document.querySelector('input[name="password2"]');
        if (confirmPasswordField) {
            confirmPasswordField.addEventListener('input', function() {
                const password = passwordField.value;
                const confirmPassword = this.value;
                
                if (confirmPassword.length === 0) return;
                
                if (password !== confirmPassword) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        }
    }
    
    // Auto-focus first input
    const firstInput = document.querySelector('input:not([type="hidden"])');
    if (firstInput) {
        firstInput.focus();
    }
});
</script>

<style>
.password-strength {
    margin-top: 0.5rem;
}

.strength-bar {
    height: 4px;
    border-radius: 2px;
    background-color: #e9ecef;
    overflow: hidden;
}

.strength-fill {
    height: 100%;
    transition: all 0.3s ease;
    width: 0%;
}

.strength-weak .strength-fill {
    background-color: #dc3545;
    width: 25%;
}

.strength-fair .strength-fill {
    background-color: #fd7e14;
    width: 50%;
}

.strength-good .strength-fill {
    background-color: #ffc107;
    width: 75%;
}

.strength-strong .strength-fill {
    background-color: #198754;
    width: 100%;
}
</style>
{% endblock %}
